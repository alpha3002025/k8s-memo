# 3.3 ~ 3.4 label, label selector

label

- 리소스에 key/value (키/값) 쌍으로 붙일 수 있습니다.
- namespace 에도 붙일수 있고 node 에도 붙일수 있고 Pod, deployment 등 다양한 리소스에 붙일수 있습니다.
- Service 등에서 Pod 또는 Deployment 를 선택할때 이 label 을 보고 선택하며, selector, labelSelector 에서 어떤 label 을 선택할지 명시합니다.

<br/>



label selector

- label 을 선택할때 사용되는 기능입니다.
- 어떤 리소스 들에 label 을 지정했다면, 그 리소스들을 선택할때 label selector 를 사용하면 그 리소스들을 선택하는 것이 가능합니다.
- 요약하면, label selector 는 "특정 레이블이 붙은 리소스들을 필터링해서 선택하는 기능"입니다.
- e.g. label selector 를 사용하는 경우들
  - label selector 로 service 가 특정 deployment/pod 를 선택(select) 및 관리
  - label selector 로 deployment 가 특정 pod 그룹을 지정(select) 및 관리
  - kubectl 로 특정 label selector 를 이용해 여러 pod 를 삭제

<br/>



레이블 셀렉터(label selector)가 리소스를 선택할 수 있는 조건은 다음과 같습니다:

- 특정 키를 가진 레이블을 **포함하거나 포함하지 않는** 경우
- 특정 키와 값을 가진 레이블을 **포함하는** 경우
- 특정 키를 가지지만 **지정한 값과 다른 값**을 가진 레이블을 포함하는 경우

<br/>



label, label selector 는 다음과 같은 작업들에도 다양하게 사용됩니다.

- 환경별 분리 (dev, staging, production)
- 버전별 관리 (stable, beta, canary)
- 서비스별 그룹화 (frontend, backend, database)
- 일괄 운영 작업 (배포, 롤백, 모니터링)



참고: kubectl 명령어 옵션

- `-l`: 레이블 셀렉터 (필터링)
- `-L`: 레이블 값을 추가 열로 표시



e.g. 특정 레이블을 가진 노드만 나열

```bash
$ kubectl get nodes -l gpu=true
NAME                        STATUS    AGE
gke-kubia-85f6-node-0rrx    Ready     1d
```



e.g. 레이블 값을 열로 표시

```
$ kubectl get nodes -L gpu
```



<br/>



# label

- Pod 및 Kubernetes 의 리소스들을 조직화할 수 있는 간단하면서도 강력한 기능입니다. 

- key/value (키/값) 쌍으로 붙이는데 이 것을 label(레이블) 이라고 부릅니다.
- 한국인은 '라벨'이라는 단어가 익숙
- 하나의 리소스는 여러 레이블을 가질수 있으며, 해당 리소스 내에서 label 의 키는 고유해야 합니다.
- 리소스를 생성할 때 레이블을 붙일수 있으며, **나중에** 추가 라벨을 붙이거나 기존 라벨의 값을 수정할 수도 있습니다 (리소스 재생성 불필요)



```plain
rel=stable (안정 버전)
─────────────────────────────────────────────────────────────
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   UI pod     │  │Account       │  │Product       │
│app: ui       │  │Service pod   │  │Catalog pod   │
│rel: stable   │  │app: as       │  │app: pc       │
└──────────────┘  │rel: stable   │  │rel: stable   │
                  └──────────────┘  └──────────────┘

┌──────────────┐  ┌──────────────┐
│Shopping      │  │Order         │
│Cart pod      │  │Service pod   │
│app: sc       │  │app: os       │
│rel: stable   │  │rel: stable   │
└──────────────┘  └──────────────┘

rel=beta (베타 버전)
─────────────────────────────────────────────────────────────
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   UI pod     │  │Product       │  │Order         │
│app: ui       │  │Catalog pod   │  │Service pod   │
│rel: beta     │  │app: pc       │  │app: os       │
└──────────────┘  │rel: beta     │  │rel: beta     │
                  └──────────────┘  └──────────────┘

rel=canary (카나리 버전)
─────────────────────────────────────────────────────────────
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│Account       │  │Product       │  │Order         │
│Service pod   │  │Catalog pod   │  │Service pod   │
│app: as       │  │app: pc       │  │app: os       │
│rel: canary   │  │rel: canary   │  │rel: canary   │
└──────────────┘  └──────────────┘  └──────────────┘

    app=ui         app=as          app=pc          app=sc        app=os
```

<br/>



1. **app 라벨**: Pod이 속한 앱, 컴포넌트 또는 마이크로서비스를 지정
   - 예: `app=ui`, `app=as`, `app=pc`, `app=sc`, `app=os`

2. **rel 라벨**: Pod에서 실행 중인 애플리케이션이 stable, beta 또는 canary 릴리스인지를 표시
   - 예: `rel=stable`, `rel=beta`, `rel=canary`



위와 같이 구분한 방식을 책에서는 다음과 같이 설명하고 있습니다.

- **가로 방향(수평)**: 앱별로 구분 (ui, as, pc, sc, os)
- **세로 방향(수직)**: 릴리스별로 구분 (stable, beta, canary)



## e.g. kubia-manual-with-labels.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-manual-v2
  ## (1)
  labels:                      # 두 개의 라벨이 Pod에 붙습니다
    creation_method: manual
    env: prod
spec:
  containers:
  - image: luksa/kubia
    name: kubia
    ports:
    - containerPort: 8080
      protocol: TCP
```

(1)

- label 로 `creation_method=manual` , `env=prod` 를 붙였습니다.



## kubectl label 

### label 붙이기

```bash
$ kubectl label po kubia-manual creation_method=manual
pod "kubia-manual" labeled
```

<br/>



### label 수정하기 (`--overwrite`)

```bash
$ kubectl label po kubia-manual-v2 env=debug --overwrite
pod "kubia-manual-v2" labeled
```

<br/>



## 레이블 확인 : kubectl get \-L

특정 Pod 에 특정 label 이 붙었는지 확인을 하는 것은 다음과 같이 할 수 있다.

```bash
$ kubectl get po -L creation_method,env
NAME              READY   STATUS    RESTARTS   AGE   CREATION_METHOD   ENV
kubia-manual      1/1     Running   0          16m   manual            <none>
kubia-manual-v2   1/1     Running   0          2m    manual            debug
kubia-zxzij       1/1     Running   0          1d    <none>            <none>
```

<br/>



# label selector

label selector

- label 을 선택할때 사용되는 기능입니다.
- 어떤 리소스 들에 label 을 지정했다면, 그 리소스들을 선택할때 label selector 를 사용하면 그 리소스들을 선택하는 것이 가능합니다.
- 요액하면, label selector 는 "특정 레이블이 붙은 리소스들을 필터링해서 선택하는 기능"입니다.



레이블 셀렉터(label selector)가 리소스를 선택할 수 있는 조건은 다음과 같습니다:
- 특정 키를 가진 레이블을 **포함하거나 포함하지 않는** 경우
- 특정 키와 값을 가진 레이블을 **포함하는** 경우
- 특정 키를 가지지만 **지정한 값과 다른 값**을 가진 레이블을 포함하는 경우
- e.g. label selector 를 사용하는 경우들
  - label selector 로 service 가 특정 deployment/pod 를 선택(select) 및 관리
  - label selector 로 deployment 가 특정 pod 그룹을 지정(select) 및 관리
  - kubectl 로 특정 label selector 를 이용해 여러 pod 를 삭제



주요 selector 들은 다음과 같습니다.

## 1. 단일 조건 셀렉터

셀렉터는 일치 여부 외에도 not 조건, notin, in 조건 등을 조합해서 사용 가능합니다.

   - 특정 키-값 쌍: `app=kubia`
   - 키 존재 여부: `env` 또는 `!env`
   - 값 불일치: `env!=prod`
   - 값 포함: `env in (prod,devel)`
   - 값 제외: `env notin (prod,devel)`



## 2. 다중 조건 셀렉터

   - 쉼표로 구분: `app=pc,rel=beta`
   - AND 조건 (모든 조건 만족 필요)
   - 더 정밀한 파드 선택 가능



## 3. 활용 범위

   - kubectl 명령어에서 파드 필터링
   - Kubernetes 컨트롤러의 파드 관리
   - 서비스의 엔드포인트 선택
   - 일괄 작업 수행 (삭제, 업데이트 등)



<br/>



## e.g. 다양한 selector 예시

| 셀렉터                    | 설명                                                         |
| ------------------------- | ------------------------------------------------------------ |
| `creation_method!=manual` | manual이 아닌 다른 값을 가진 creation_method 레이블을 가진 파드 선택 |
| `env in (prod,devel)`     | env 레이블이 prod 또는 devel로 설정된 파드 선택              |
| `env notin (prod,devel)`  | env 레이블이 prod 또는 devel이 아닌 다른 값으로 설정된 파드 선택 |

<br/>



## e.g. figure 3.8 : app=pc label selector

마이크로서비스 아키텍처 예제에서 `app=pc` 레이블 셀렉터를 사용하면 제품 카탈로그(Product Catalog) 마이크로서비스의 일부인 모든 파드를 선택할 수 있습니다.

**그림 설명:**

- 여러 마이크로서비스 파드들이 표시됨:
  - UI pods (app: ui)
  - Account Service pods (app: as)
  - **Product Catalog pods (app: pc)** ← 선택됨
  - Shopping Cart pods (app: sc)
  - Order Service pods (app: os)
- 각 서비스는 stable, beta, canary 릴리스로 구분됨
- `app=pc` 셀렉터는 릴리스 버전에 관계없이 모든 Product Catalog 파드를 선택함



## e.g. 다중 조건 셀렉터 (여러 레이블 선택)

셀렉터는 **쉼표로 구분된 여러 기준**을 포함할 수도 있습니다. 리소스가 셀렉터와 일치하려면 **모든 기준을 만족**해야 합니다.

예를 들어 제품 카탈로그 마이크로서비스의 베타 릴리스만 실행하는 파드만 선택하려면:

```
app=pc,rel=beta
```

이 셀렉터는 다음 두 조건을 **모두** 만족하는 파드만 선택합니다:
- `app` 레이블이 `pc`인 파드
- `rel` 레이블이 `beta`인 파드



## e.g. figure 3.9 : 다중 레이블 셀렉터를 사용한 파드 선택

figure 3.9 는 여러 레이블 셀렉터를 사용한 파드 선택을 시각화하고 있습니다.



**전체 마이크로서비스 구조:**
- **Stable 릴리스 (rel=stable):**
  - UI pod (app: ui, rel: stable)
  - Account Service pod (app: as, rel: stable)
  - Product Catalog pod (app: pc, rel: stable)
  - Shopping Cart pod (app: sc, rel: stable)
  - Order Service pod (app: os, rel: stable)

- **Beta 릴리스 (rel=beta):**
  - UI pod (app: ui, rel: beta)
  - Product Catalog pod (app: pc, rel: beta) ← **선택됨**
  - Order Service pod (app: os, rel: beta)

- **Canary 릴리스 (rel=canary):**
  - Account Service pod (app: as, rel: canary)
  - Product Catalog pod (app: pc, rel: canary)
  - Order Service pod (app: os, rel: canary)



**`app=pc,rel=beta` 셀렉터의 동작:**

- Product Catalog 서비스 중에서도 **베타 릴리스 파드만** 선택됨
- stable과 canary 릴리스의 Product Catalog 파드는 제외됨
- 두 가지 조건을 모두 만족하는 파드만 선택된다는 것을 명확히 보여줌



<br/>



# 참고: kubectl 명령어 옵션

- `-l`: 레이블 셀렉터 (필터링)
- `-L`: 레이블 값을 추가 열로 표시



e.g. 특정 레이블을 가진 노드만 나열

```bash
$ kubectl get nodes -l gpu=true
NAME                        STATUS    AGE
gke-kubia-85f6-node-0rrx    Ready     1d
```



e.g. 레이블 값을 열로 표시

```
$ kubectl get nodes -L gpu
```



