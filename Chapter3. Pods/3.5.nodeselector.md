# 3.5. NodeSelector

Pod, Deployment 는 실행될 node 를 선택할수 있습니다. "Node 를 선택(Select)한다"는 의미에 맞게 NodeSelector 라는 이름으로 부르는 개념이 있는데 이에 대해 알아봅니다.<br/>

Pod 에는 `spec.nodeSelector` 라는 필드에 label 을 지정해서 노드를 선택할수 있습니다. 예를 들어 높은 사양의 GPU 가 필요한 작업의 경우 `gpu=high` 레이블을 nodeSelector 내에 두어서 높은사양의 node 로 스케쥴링 되도록 할수 있습니다. (Deployment 역시 자신이 실행될 node 를 선택하는 것이 가능합니다.)

e.g.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-gpu
spec:
  nodeSelector:           # 노드 셀렉터 정의
    gpu: "true"           # gpu=true 레이블을 가진 노드에만 스케줄링
  containers:
  - image: luksa/kubia
    name: kubia
```

`kubia-gpu` 라는 이름의 Pod 가 `gpu=true` 레이블이 붙은 노드로 스케쥴링 되도록 `nodeSelector` 를 정의했습니다.<br/>

이와 같이 `nodeSelector` 를 이용하면  특정 파드 또는 파드 그룹을 특정 노드 유형에서 실행되도록 지정하는 것이 가능합니다.



**고급스케쥴링 기법**

Node Selector 말고도 Affinity, Taint, Toleration 이라는 개념이 있는데 이에 대해서는 16장에서 다루게 됩니다.

- **Node Affinity**: 노드 셀렉터보다 더 표현력 있는 메커니즘
- **Pod Affinity/Anti-Affinity**: 파드 간의 관계 기반 스케줄링
- **Taints and Tolerations**: 특정 파드를 노드에서 밀어내거나 끌어당기기

<br/>



# 주요 명령어

노드 관련 명령어

```bash
# 노드 목록 조회
kubectl get nodes

# 노드에 레이블 추가
kubectl label node <node-name> <key>=<value>

# 레이블 셀렉터로 노드 필터링
kubectl get nodes -l <key>=<value>

# 레이블 값을 열로 표시
kubectl get nodes -L <label-key>
```

<br/>



파드 관련 명령어

```bash
# YAML 파일로 파드 생성
kubectl create -f <filename.yaml>

# 레이블 셀렉터로 파드 필터링
kubectl get pods -l <key>=<value>

# 다중 조건 레이블 셀렉터
kubectl get pods -l <key1>=<value1>,<key2>=<value2>
```

<br/>



# label, selector 를 이용해 pod 를 원하는 Node 에 스케쥴링

## e.g.

예를 들어 다음과 같은 방식으로 node를 선택해서 pod 를 원하는 Node 에 스케쥴링 할 수 있습니다.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-gpu
spec:
  nodeSelector:           # 노드 셀렉터 정의
    gpu: "true"           # gpu=true 레이블을 가진 노드에만 스케줄링
  containers:
  - image: luksa/kubia
    name: kubia
```

**주요 필드:**

- `spec.nodeSelector`: 파드를 스케줄링할 노드의 조건을 지정
- `gpu: "true"`: GPU 레이블이 true인 노드만 선택

**동작 원리:**

1. `spec` 섹션 아래에 `nodeSelector` 필드를 추가
2. 파드를 생성하면 스케줄러는 `gpu=true` 레이블을 포함하는 노드 중에서만 선택
3. 이 경우 단일 노드만 해당 레이블을 가지고 있음



파드 생성

```bash
$ kubectl create -f kubia-gpu.yaml
```

이 명령으로 파드가 생성되면, Kubernetes 스케줄러는 자동으로 `gpu=true` 레이블을 가진 노드에 파드를 배치합니다.<br/>



## 파드 스케쥴링

파드가 노드에 배치되는 것을 '파드 스케쥴링'이라고 부릅니다. 일반적인 파드 스케쥴링 원칙은 다음과 같습니다.

- 요청한 정확한 양의 컴퓨팅 리소스(CPU, 메모리 등)를 받습니다
- 다른 파드로부터의 접근성은 파드가 스케줄링된 노드에 전혀 영향을 받지 않습니다
- 일반적으로 Kubernetes에 파드를 정확히 어디에 스케줄링할지 지시할 필요가 없습니다



하지만 파드마다 필요한 하드웨어의 속성이 다를 수 있습니다. 그리고 어떤 워커 노드는 회전식 하드 드라이브 (HDD)를 가지고 있을 수도 있으며, 어떤 파드는 특정 그룹의 노드 들에만 배치하고 싶을때(운영상의 편의를 위해)가 있을 수 있습니다.

- 일부 워커 노드는 회전식 하드 드라이브(HDD)를 가지고 있음
- 다른 노드들은 SSD를 가지고 있음
- 특정 파드는 한 그룹의 노드에, 나머지는 다른 그룹에 스케줄링하고 싶을 수 있음



또는 다음과 같이 GPU 연산을 필요로 하는 경우도 있습니다.

- GPU 기반의 집약적인 계산을 수행하는 파드
- 필요한 GPU 가속을 제공하는 노드에만 스케줄링해야 함



이런 경우 위에서 살펴봤듯 label,selector 를 통해 어떤 노드에서 실행될 지를 지정할 수 있습니다.<br/>



## 노드 지정(Select) 시의 원칙

특정 노드를 정확히 지정하지 마세요.

- 특정 노드를 명확히 지정해서 선택하기보다는 label 등과 같은 논리적인 그룹을 통해 지정해야 합니다.
- 특정 노드를 지정하는 것은 애플리케이션을 인프라에 결합시킵니다.
- kubernetes 의 전체 아이디어는 실제 인프라를 그 위에서 실행되는 앱으로부터 숨기는 것입니다.



호스트 명을 사용해 파드를 노드에 스케쥴링 하지 마세요. 

`nodeSelector` 를 호스트명 레이블로 특정 노드에 설정하면

- 노드가 오프라인일 경우 파드가 스케쥴 불가능하게 될 수 있음
- 애플리케이션이 특정 인프라에 강하게 결함됨



개별 노드 관점에서 생각하지 마세요.

**대신 다음과 같이 접근하세요:**

- 레이블 셀렉터를 통해 지정된 특정 기준을 충족하는 **노드의 논리적 그룹**으로 생각
- 예: "GPU가 있는 노드", "SSD가 있는 노드", "zone1에 있는 노드"



❌ **나쁜 예:**
```yaml
nodeSelector:
  kubernetes.io/hostname: node-1  # 특정 노드에 종속
```

<br/>



✅ **좋은 예:**

```yaml
nodeSelector:
  gpu: "true"              # GPU 기능을 가진 노드 그룹
  storage-type: "ssd"      # SSD를 가진 노드 그룹
```

<br/>



## Best Practice - ✅ 권장사항

1. **논리적 그룹화 사용**: 개별 노드가 아닌 노드 그룹으로 생각
2. **의미 있는 레이블 사용**: `gpu=true`, `disk-type=ssd` 등 명확한 레이블 사용
3. **다중 레이블 활용**: 여러 차원으로 리소스 분류
4. **일관된 네이밍**: 팀 전체에서 일관된 레이블 키와 값 사용



## Worst Practice - ❌ 피해야 할 사항

1. **호스트명으로 직접 스케줄링**: 특정 노드 이름 사용 지양
2. **과도한 제약**: 너무 구체적인 nodeSelector는 스케줄링 실패 가능성 증가
3. **레이블 불일치**: 노드 레이블과 파드 nodeSelector 불일치 주의





# 참고: kubectl 명령어 옵션

- `-l`: 레이블 셀렉터 (필터링)
- `-L`: 레이블 값을 추가 열로 표시



e.g. 특정 레이블을 가진 노드만 나열

```bash
$ kubectl get nodes -l gpu=true
NAME                        STATUS    AGE
gke-kubia-85f6-node-0rrx    Ready     1d
```



e.g. 레이블 값을 열로 표시

```
$ kubectl get nodes -L gpu
```















